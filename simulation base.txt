 data eggs;
        input y freq;
        datalines;
        0  32
        1  1681
        2  353
        3  86
        4  35
        5  11
        6  6
        7  2
;

 proc countreg data=eggs;
         model y = / dist=Poisson;
         output out=exp_nb prob=prob_nb;
         freq freq;
         run;

data lambda;
 lambda=exp(0.27);
 run;


 proc sql noprint;
   create table aa as 
     select stysid1a, mfas, exbh, trtn,trtc
      from data_a.aident 
	  where mfas eq 1 and trtn ne .;
	  quit;
	  
	  
	  proc sql noprint;
  create table exb as
   select distinct stysid1a, param_1a, mFAS,VAL_1N, trtn, trtc, exbh
     from data_a.aexbder
	 where trtn in (1 4) and param_1a eq 'EXBCNUM' AND mFAS EQ 1;
	 QUIT;
	 
	 proc sort data=exb;
	 by trtn;
	 run;
	 
	 ods listing ;
ods output Estimates=est_group 
           LSMeans=lsm_group;
PROC genmod DATA=exb order=data;
  CLASS trtn;
  MODEL val_1n =trtn exbh
       /DIST= negbin link=log/* ZIP P*/   offset=lrisk ;*TYPE3 WALD;
       run;
       
       
       
/* simulate N=400, 1000,2000 past recurrent event number */
/*Poisson distributed with lambda=1.31 based on study QVA2304*/
options mprint source;

%macro sim_binom(N=,K= , rr_trt=,lambda_baseline=,op=,mar_ni=)/minoperator;
/* N sample size                             *
 * repeat number for simulation K            *
 * group, treatment group-categorical with values   *
 * 1-test drug group  0-active comparator drug group *
 * rr_trt recurrent event rate ratio between test drug group and active comparator drug group *
 * lambda_baseline the mean recurrent event number assuming Poisson distribution              *  
 * mar_ni non-inferiority margin of rate ratio between test drug group and active comparator drug group *
 * op-overdispersion parameter in negative binomial model * /
 /*generate baseline event number in the past time duration with T=1 year */
 /*assume Poisson distribution with lamda=lambda_baseline */
%do k=1 %to &K;
data baseline;
   m1=&lambda_baseline.;

   %do j=1 %to &N/2;
      group=1;
      num_bs=rand('POISSON',m1);
	  output;
   %end;
 %do j= &N/2+1 %to &N;
      group=2;
      num_bs=rand('POISSON',m1);
	  output;
   %end;


keep num_bs; 
keep group;
 run;
 data event1;
  set baseline;
   rr1=&rr_trt.;
   if group eq 1 then group_i=1;
   else if group eq 2 then group_i=0;
 m_event=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr1));
 alpha=1/&op;
 beta=m_event*&op.;
   lrisk=log(365.25);
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta*rangam(seed,alpha);
num_event=rand('POISSON',gamma);
keep num_event lrisk num_bs group;
   run;  


proc sort data=event1;
by group;
run;


/*P-value for superiority test need to divide by 2 */
/*Estimate and 95% CI the same */
	 ods listing ;
ods output Estimates=est_group 
           LSMeans=lsm_group;
PROC genmod DATA=event1 order=data;
  CLASS group;
  MODEL num_event =group num_bs
       /DIST= negbin link=log/* ZIP P*/   offset=lrisk ;*TYPE3 WALD;
  lsmeans group /  cl;     
 estimate 'test-active' group 1 -1  /exp;      
       run;
       
 data est_group1;
   set est_group      
IF label eq 'Exp(test-active)'  then upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
%if upper lt marni and upper ne . %then ind_ni=1;
%else %if upper ge marni %then ind_ni=0;
ord=k;
output;
%end;
keep ord ind_ni ind_sup;
run;

proc sort data=est_group1;
by ord;
run;


proc sql noprint;
  select min(ord) into: ord1
    from est_group1;
quit;
%end;

%do &ord1.=1 %to &k;  
  data count_p;
   set est_group_&ord1.;
   if p_ni ne . and p_ni lt .025 then count_pni=1;
   else if p_ni ge .025 then count_pni=0;
    if p_sup ne . and p_sup lt .025 then count_psup=1;
   else if p_sup ge .025 then count_psup=0;
   %end;
   run;
   data count_p1;
     set count_p;
   type1e_ni=sum(count_pni)/&k;
   type1e_sup=sum(count_psup)/&k;
   run;
%mend sim_binom;
 
   
%macro sim_binom(N=,K= , rr_trt=,lambda_baseline=,op=,mar_ni=)/minoperator;
/* N sample size                             *
 * repeat number for simulation K            *
 * group, treatment group-categorical with values   *
 * 1-test drug group  2-active comparator drug group *
 * rr_trt recurrent event rate ratio between test drug group and active comparator drug group *
 * lambda_baseline the mean recurrent event number assuming Poisson distribution              *  
 * mar_ni non-inferiority margin of rate ratio between test drug group and active comparator drug group *
 * op-overdispersion parameter in negative binomial model * /
 /*generate baseline event number in the past time duration with T=1 year */
 /*assume Poisson distribution with lamda=lambda_baseline */
data baseline;
   m1=&lambda_baseline.;

   %do j=1 %to &N/2;
      group=1;
      num_bs=rand('POISSON',m1);
	  output;
   %end;
 %do j= &N/2+1 %to &N;
      group=2;
      num_bs=rand('POISSON',m1);
	  output;
   %end;


keep num_bs; 
keep group;
 run;
 data event1;
  set baseline;
   rr1=&rr_trt.;
   if group eq 1 then group_i=1;
   else if group eq 2 then group_i=0;
 m_event=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr1));
 alpha=1/&op;
 beta=m_event*&op.;
   lrisk=log(365.25);
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta*rangam(seed,alpha);
num_event=rand('POISSON',gamma);
keep num_event lrisk num_bs group;
   run;  


proc sort data=event1;
by group;
run;


/*P-value for superiority test need to divide by 2 */
/*Estimate and 95% CI the same */
	 ods listing ;
ods output Estimates=est_group2 
           LSMeans=lsm_group2;
PROC genmod DATA=event1 order=data;
  CLASS group;
  MODEL num_event =group num_bs
       /DIST= negbin link=log/* ZIP P*/   offset=lrisk ;*TYPE3 WALD;
  lsmeans group /  cl;     
 estimate 'test-active' group 1 -1  /exp;      
       run;

%mend sim_binom;

%sim_binom(N=2000,K=10 , rr_trt=0.9,lambda_baseline=1.31,op=0.677,mar_ni=1.15);


%macro sim_binom(N=,K= , rr_trt=,lambda_baseline=,op=,mar_ni=)/minoperator;
/* N sample size                             *
 * repeat number for simulation K            *
 * group, treatment group-categorical with values   *
 * 1-test drug group  2-active comparator drug group *
 * rr_trt recurrent event rate ratio between test drug group and active comparator drug group *
 * lambda_baseline the mean recurrent event number assuming Poisson distribution              *  
 * mar_ni non-inferiority margin of rate ratio between test drug group and active comparator drug group *
 * op-overdispersion parameter in negative binomial model * /
 /*generate baseline event number in the past time duration with T=1 year */
 /*assume Poisson distribution with lamda=lambda_baseline */
%do m=1 %to &K;

data baseline_&m.;
   m1=&lambda_baseline.;

   %do j=1 %to &N/2;
      group=1;
      num_bs=rand('POISSON',m1);
	  output;
   %end;
 %do j= &N/2+1 %to &N;
      group=2;
      num_bs=rand('POISSON',m1);
	  output;
   %end;


keep num_bs; 
keep group;
 run;
 data event1_&m.;
  set baseline_&m.;
   rr1=&rr_trt.;
   if group eq 1 then group_i=1;
   else if group eq 2 then group_i=0;
 m_event=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr1));
 alpha=1/&op;
 beta=m_event*&op.;
   lrisk=log(365.25);
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta*rangam(seed,alpha);
num_event=rand('POISSON',gamma);
keep num_event lrisk num_bs group;
   run;  


proc sort data=event1_&m.;
by group;
run;


/*P-value for superiority test need to divide by 2 */
/*Estimate and 95% CI the same */
	 ods listing ;
ods output Estimates=est_group 
           LSMeans=lsm_group;
PROC genmod DATA=event1_&m. order=data;
  CLASS group;
  MODEL num_event =group num_bs
       /DIST= negbin link=log/* ZIP P*/   offset=lrisk ;*TYPE3 WALD;
  lsmeans group /  cl;     
 estimate 'test-active' group 1 -1  /exp;      
       run;
       
 data summary;
   set est_group_&m.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=&m.;
output;
run;
%end;
data summary;
 
%mend sim_binom;

%sim_binom(N=400,K=2 , rr_trt=0.9,lambda_baseline=1.31,op=0.677,mar_ni=1.15);  



%macro sim_binom(N=,K= , rr_trt=,lambda_baseline=,op=,mar_ni=)/minoperator;
/* N sample size                             *
 * repeat number for simulation K            *
 * group, treatment group-categorical with values   *
 * 1-test drug group  2-active comparator drug group *
 * rr_trt recurrent event rate ratio between test drug group and active comparator drug group *
 * lambda_baseline the mean recurrent event number assuming Poisson distribution              *  
 * mar_ni non-inferiority margin of rate ratio between test drug group and active comparator drug group *
 * op-overdispersion parameter in negative binomial model * /
 /*generate baseline event number in the past time duration with T=1 year */
 /*assume Poisson distribution with lamda=lambda_baseline */
%do m=1 %to &K;

data baseline_&m.;
   m1=&lambda_baseline.;

   %do j=1 %to &N/2;
      group=1;
      num_bs=rand('POISSON',m1);
	  output;
   %end;
 %do j= &N/2+1 %to &N;
      group=2;
      num_bs=rand('POISSON',m1);
	  output;
   %end;


keep num_bs; 
keep group;
 run;
 data event1_&m.;
  set baseline_&m.;
   rr1=&rr_trt.;
   if group eq 1 then group_i=1;
   else if group eq 2 then group_i=0;
 m_event=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr1));
 alpha=1/&op;
 beta=m_event*&op.;
   lrisk=log(365.25);
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta*rangam(seed,alpha);
num_event=rand('POISSON',gamma);
keep num_event lrisk num_bs group;
   run;  


proc sort data=event1_&m.;
by group;
run;


/*P-value for superiority test need to divide by 2 */
/*Estimate and 95% CI the same */
	 ods listing ;
ods output Estimates=est_group_&m.; 
PROC genmod DATA=event1_&m. order=data;
  CLASS group;
  MODEL num_event =group num_bs
       /DIST= negbin link=log/* ZIP P*/   offset=lrisk ;*TYPE3 WALD;
  lsmeans group /  cl;     
 estimate 'test-active' group 1 -1  /exp;      
       run;
 %if &m. eq 1 %then %do;      
 data summary;
   set est_group_&m.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%else  %if &m. ne 1 %then %do;      
 data summary;
   set est_group_&m. summary;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%end;
proc sql noprint;
create table summary1 as 
  select sum(ind_ni)/sum(order) as pct_ni
	,sum(ind_sup)/sum(order) as pct_sup,label 
	from summary
	group by label;
	quit;
%mend sim_binom;

%sim_binom(N=400,K=100 , rr_trt=0.9,lambda_baseline=1.31,op=0.677,mar_ni=1.15);



%macro sim_binom(N=,K= , rr_trt=,lambda_baseline=,op=,mar_ni=)/minoperator;
/* N sample size                             *
 * repeat number for simulation K            *
 * group, treatment group-categorical with values   *
 * 1-test drug group  2-active comparator drug group *
 * rr_trt recurrent event rate ratio between test drug group and active comparator drug group *
 * lambda_baseline the mean recurrent event number assuming Poisson distribution              *  
 * mar_ni non-inferiority margin of rate ratio between test drug group and active comparator drug group *
 * op-overdispersion parameter in negative binomial model * /
 /*generate baseline event number in the past time duration with T=1 year */
 /*assume Poisson distribution with lamda=lambda_baseline */
%do m=1 %to &K;

data baseline_&m.;
   m1=&lambda_baseline.;

   %do j=1 %to &N/2;
      group=1;
      num_bs=rand('POISSON',m1);
	  output;
   %end;
 %do j= &N/2+1 %to &N;
      group=2;
      num_bs=rand('POISSON',m1);
	  output;
   %end;


keep num_bs; 
keep group;
 run;
 data event1_&m.;
  set baseline_&m.;
   rr1=&rr_trt.;
   if group eq 1 then group_i=1;
   else if group eq 2 then group_i=0;
 m_event=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr1));
%if %type eq negbio %then %do;
 alpha=1/&op;
 beta=m_event*&op.;
   lrisk=log(365.25);
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta*rangam(seed,alpha);
num_event=rand('POISSON',gamma);
%end;
%else %if %type eq pois %then %do;
num_event=rand('POISSON',m_event);
%end;
%else %if %type eq poismix1 %then %do;
num_event=rand('POISSON',m_event);
%end;
keep num_event lrisk num_bs group;
   run;  


proc sort data=event1_&m.;
by group;
run;


/*P-value for superiority test need to divide by 2 */
/*Estimate and 95% CI the same */
	 ods listing ;
ods output Estimates=est_group_&m.; 
PROC genmod DATA=event1_&m. order=data;
  CLASS group;
  MODEL num_event =group num_bs
       /DIST= negbin link=log/* ZIP P*/   offset=lrisk ;*TYPE3 WALD;
  lsmeans group /  cl;     
 estimate 'test-active' group 1 -1  /exp;      
       run;
 %if &m. eq 1 %then %do;      
 data summary;
   set est_group_&m.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%else  %if &m. ne 1 %then %do;      
 data summary;
   set est_group_&m. summary;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%end;
proc sql noprint;
create table summary1 as 
  select sum(ind_ni)/sum(order) as pct_ni
	,sum(ind_sup)/sum(order) as pct_sup,label 
	from summary
	group by label;
	quit;
%mend sim_binom;

%sim_binom(N=2000,K=1000 , rr_trt=1.075,lambda_baseline=1.31,op=0.677,mar_ni=1.15); 





%macro sim_binom(N=,K= , rr_trt=,lambda_baseline=,op=,mar_ni=, type=)/minoperator;
/* N sample size                             *
 * repeat number for simulation K            *
 * group, treatment group-categorical with values   *
 * 1-test drug group  2-active comparator drug group *
 * rr_trt recurrent event rate ratio between test drug group and active comparator drug group *
 * lambda_baseline the mean recurrent event number assuming Poisson distribution              *  
 * mar_ni non-inferiority margin of rate ratio between test drug group and active comparator drug group *
 * op-overdispersion parameter in negative binomial model * /
 /*generate baseline event number in the past time duration with T=1 year */
 /*assume Poisson distribution with lamda=lambda_baseline */
%do m=1 %to &K;

data baseline_&m.;
   m1=&lambda_baseline.;

   %do j=1 %to &N/2;
      group=1;
      num_bs=rand('POISSON',m1);
	  output;
   %end;
 %do j= &N/2+1 %to &N;
      group=2;
      num_bs=rand('POISSON',m1);
	  output;
   %end;


keep num_bs; 
keep group;
 run;
 data event1_&m.;
  set baseline_&m.;
   rr1=&rr_trt.;
   if group eq 1 then group_i=1;
   else if group eq 2 then group_i=0;
 m_event=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr1));
  lrisk=log(365.25);
%if &type. eq negbio %then %do;
 alpha=1/&op;
 beta=m_event*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta*rangam(seed,alpha);
num_event=rand('POISSON',gamma);
%end;
%else %if &type. eq pois %then %do;
num_event=rand('POISSON',m_event);
%end;
%else %if &type. eq poismix1 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.5)
 %end;
rr11=rr1+0.1;
rr12=rr1-0.1;
 if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr11));
num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
m_event2=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;
%end;
%else %if &type. eq poismix2 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.1)
 %end;
rr11=rr1+0.18;
rr12=rr1-0.02;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr11));
num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
  m_event2=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;
%end;
%else %if &type. eq poismix3 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9)
 %end;
rr12=rr1+0.05;
rr11=rr1-0.45;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr11));

num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
  m_event2=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;

%end;



keep num_event lrisk num_bs group;
   run;  


proc sort data=event1_&m.;
by group;
run;


/*P-value for superiority test need to divide by 2 */
/*Estimate and 95% CI the same */
	 ods listing ;
ods output Estimates=est_group_&m.; 
PROC genmod DATA=event1_&m. order=data;
  CLASS group;
  MODEL num_event =group num_bs
       /DIST= negbin link=log/* ZIP P*/   offset=lrisk ;*TYPE3 WALD;
  lsmeans group /  cl;     
 estimate 'test-active' group 1 -1  /exp;      
       run;
 %if &m. eq 1 %then %do;      
 data summary;
   set est_group_&m.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%else  %if &m. ne 1 %then %do;      
 data summary;
   set est_group_&m. summary;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%end;
proc sql noprint;
create table summary1 as 
  select sum(ind_ni)/sum(order) as pct_ni
	,sum(ind_sup)/sum(order) as pct_sup,label 
	from summary
	group by label;
	quit;
%mend sim_binom;

%sim_binom(N=5000,K=1000 , rr_trt=0.975,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=negbio); 

%macro sim_binom(N=,K= , rr_trt=,lambda_baseline=,op=,mar_ni=, type=)/minoperator;
/* N sample size                             *
 * repeat number for simulation K            *
 * group, treatment group-categorical with values   *
 * 1-test drug group  2-active comparator drug group *
 * rr_trt recurrent event rate ratio between test drug group and active comparator drug group *
 * lambda_baseline the mean recurrent event number assuming Poisson distribution              *  
 * mar_ni non-inferiority margin of rate ratio between test drug group and active comparator drug group *
 * op-overdispersion parameter in negative binomial model * /
 /*generate baseline event number in the past time duration with T=1 year */
 /*assume Poisson distribution with lamda=lambda_baseline */
%do m=1 %to &K;

data baseline_&m.;
   m1=&lambda_baseline.;

   %do j=1 %to &N/2;
      group=1;
      num_bs=rand('POISSON',m1);
	  output;
   %end;
 %do j= &N/2+1 %to &N;
      group=2;
      num_bs=rand('POISSON',m1);
	  output;
   %end;


keep num_bs; 
keep group;
 run;
 data event1_&m.;
  set baseline_&m.;
   rr1=&rr_trt.;
   if group eq 1 then group_i=1;
   else if group eq 2 then group_i=0;
 m_event=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr1));
  lrisk=log(365.25);
%if &type. eq negbio %then %do;
 alpha=1/&op;
 beta=m_event*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta*rangam(seed,alpha);
num_event=rand('POISSON',gamma);
%end;
%else %if &type. eq pois %then %do;
num_event=rand('POISSON',m_event);
%end;
%else %if &type. eq poismix1 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.5);
 %end;
rr11=rr1*1.2;
rr12=rr1*0.8;
 if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr11));
num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
m_event2=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;
%end;
%else %if &type. eq poismix2 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.1);
 %end;
rr11=rr1*0.8;
rr12=rr1*2.8;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr11));
num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
  m_event2=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;
%end;
%else %if &type. eq poismix3 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
rr12=rr1*0.55;
rr11=rr1*1.05;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr11));

num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
  m_event2=exp(-0.5+0.39*num_bs+log(365.25)+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;

%end;



keep num_event lrisk num_bs group group2;
   run;  


proc sort data=event1_&m.;
by group;
run;


/*P-value for superiority test need to divide by 2 */
/*Estimate and 95% CI the same */
	 ods listing ;
ods output Estimates=est_group_&m.; 
PROC genmod DATA=event1_&m. order=data;
  CLASS group;
  MODEL num_event =group num_bs
       /DIST= negbin link=log/* ZIP P*/   offset=lrisk ;*TYPE3 WALD;
  lsmeans group /  cl;     
 estimate 'test-active' group 1 -1  /exp;      
       run;
 %if &m. eq 1 %then %do;      
 data summary;
   set est_group_&m.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%else  %if &m. ne 1 %then %do;      
 data summary;
   set est_group_&m. summary;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%end;
proc sql noprint;
create table summary1 as 
  select sum(ind_ni)/sum(order) as pct_ni
	,sum(ind_sup)/sum(order) as pct_sup,label 
	from summary
	group by label;
	quit;
%mend sim_binom;

%sim_binom(N=3000,K=1000, rr_trt=1.1,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=poismix3); 




%macro sim_binom(N=,K= , rr_trt=,lambda_baseline=,op=,mar_ni=, type=)/minoperator;
/* N sample size                             *
 * repeat number for simulation K            *
 * group, treatment group-categorical with values   *
 * 1-test drug group  2-active comparator drug group *
 * rr_trt recurrent event rate ratio between test drug group and active comparator drug group *
 * lambda_baseline the mean recurrent event number assuming Poisson distribution              *  
 * mar_ni non-inferiority margin of rate ratio between test drug group and active comparator drug group *
 * op-overdispersion parameter in negative binomial model * /
 /*generate baseline event number in the past time duration with T=1 year */
 /*assume Poisson distribution with lamda=lambda_baseline */
%do m=1 %to &K;

data baseline_&m.;
   m1=&lambda_baseline.;

   %do j=1 %to &N/2;
      group=1;
      num_bs=rand('POISSON',m1);
	  output;
   %end;
 %do j= &N/2+1 %to &N;
      group=2;
      num_bs=rand('POISSON',m1);
	  output;
   %end;


keep num_bs; 
keep group;
 run;
 data event1_&m.;
  set baseline_&m.;
   rr1=&rr_trt.;
   if group eq 1 then group_i=1;
   else if group eq 2 then group_i=0;
 m_event=exp(-0.5+0.39*num_bs+group_i*log(rr1));
  lrisk=log(365.25);
%if &type. eq negbio %then %do;
 alpha=1/&op;
 beta=m_event*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta*rangam(seed,alpha);
num_event=rand('POISSON',gamma);
%end;
%else %if &type. eq pois %then %do;
num_event=rand('POISSON',m_event);
%end;

%else %if &type. eq gammamix3 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*0.95;
rr12=rr1*1.45;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;
%else %if &type. eq rdiff1 %then %do;
alpha=1/&op.;
rr11=0.8*rr1;
rr12=1.2*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff1 %then %do;
alpha=1/&op.;
rr11=1.2*rr1;
rr12=0.8*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq rdiff0 %then %do;
alpha=1/&op.;
rr11=1.0*rr1;
rr12=1.0*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq gammamix2 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*0.9;
rr12=rr1*1.9;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;
%else %if &type. eq gammamix1 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*1.2;
rr12=rr1*0.8;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;



%else %if &type. eq poismix1 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.5);
 %end;
rr11=rr1*1.2;
rr12=rr1*0.8;
 if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;
%end;
%else %if &type. eq poismix2 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.1);
 %end;
rr11=rr1*0.8;
rr12=rr1*2.8;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
  m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;
%end;
%else %if &type. eq poismix3 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
rr12=rr1*0.55;
rr11=rr1*1.05;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));

num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
  m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;

%end;



keep num_event lrisk num_bs group group2;
   run;  


proc sort data=event1_&m.;
by group;
run;


/*P-value for superiority test need to divide by 2 */
/*Estimate and 95% CI the same */
	 ods listing ;
ods output Estimates=est_group_&m.; 
PROC genmod DATA=event1_&m. order=data;
  CLASS group;
  MODEL num_event =group num_bs
       /DIST= negbin link=log/* ZIP P*/   offset=lrisk ;*TYPE3 WALD;
  lsmeans group /  cl;     
 estimate 'test-active' group 1 -1  /exp;      
       run;
 %if &m. eq 1 %then %do;      
 data summary;
   set est_group_&m.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%else  %if &m. ne 1 %then %do;      
 data summary;
   set est_group_&m. summary;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%end;
proc sql noprint;
create table summary1 as 
  select sum(ind_ni)/sum(order) as pct_ni
	,sum(ind_sup)/sum(order) as pct_sup,label 
	from summary
	where ind_ni ne . and ind_sup ne .
	group by label;
	quit;
%mend sim_binom;

%sim_binom(N=3000,K=1000, rr_trt=1.1,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=poismix3); 

%macro gammamix(p=,op=,beta=,rmulti=)/minoperator;
data mean;
bb=(&p.*&rmulti.*&rmulti.-1)*&beta.*&beta.+(&p.*&r.-1)*&beta.;
bb1=bb/(1-&p.);
beta1=&rmulti.*beta;
bb11=1-4*bb1;
if bb11 gt 0 then do;
bb2=sqrt(bb11);
end;
if bb2 ge 2 then do;
pct=1;
beta2=bb2/2-0.5;
end;
else if bb2 lt 2 and bb2 ne . then do;
pct=0;
beta2=.;
end;
run;
%mend gammamix;


%macro sim_binom(N=,K= , rr_trt=,lambda_baseline=,op=,mar_ni=, type=)/minoperator;
/* N sample size                             *
 * repeat number for simulation K            *
 * group, treatment group-categorical with values   *
 * 1-test drug group  2-active comparator drug group *
 * rr_trt recurrent event rate ratio between test drug group and active comparator drug group *
 * lambda_baseline the mean recurrent event number assuming Poisson distribution              *  
 * mar_ni non-inferiority margin of rate ratio between test drug group and active comparator drug group *
 * op-overdispersion parameter in negative binomial model * /
 /*generate baseline event number in the past time duration with T=1 year */
 /*assume Poisson distribution with lamda=lambda_baseline */
%do m=1 %to &K;

data baseline_&m.;
   m1=&lambda_baseline.;

   %do j=1 %to &N/2;
      group=1;
      num_bs=rand('POISSON',m1);
	  output;
   %end;
 %do j= &N/2+1 %to &N;
      group=2;
      num_bs=rand('POISSON',m1);
	  output;
   %end;


keep num_bs; 
keep group;
 run;
 data event1_&m.;
  set baseline_&m.;
   rr1=&rr_trt.;
   if group eq 1 then group_i=1;
   else if group eq 2 then group_i=0;
 m_event=exp(-0.5+0.39*num_bs+group_i*log(rr1));
  lrisk=log(365.25);
%if &type. eq negbio %then %do;
 alpha=1/&op;
 beta=m_event*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta*rangam(seed,alpha);
num_event=rand('POISSON',gamma);
%end;
%else %if &type. eq pois %then %do;
num_event=rand('POISSON',m_event);
%end;

%else %if &type. eq gammamix3 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*0.95;
rr12=rr1*1.45;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;
%else %if &type. eq rdiff1 %then %do;
alpha=1/&op.;
rr11=0.8*rr1;
rr12=1.2*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff2 %then %do;
alpha=1/&op.;
rr11=1.2*rr1;
rr12=0.8*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq rdiff0 %then %do;
alpha=1/&op.;
rr11=1.0*rr1;
rr12=1.0*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq gammamix2 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*0.9;
rr12=rr1*1.9;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;
%else %if &type. eq gammamix1 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*1.2;
rr12=rr1*0.8;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;



%else %if &type. eq poismix1 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.5);
 %end;
rr11=rr1*1.2;
rr12=rr1*0.8;
 if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;
%end;
%else %if &type. eq poismix2 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.1);
 %end;
rr11=rr1*0.8;
rr12=rr1*2.8;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
  m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;
%end;
%else %if &type. eq poismix3 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
rr12=rr1*0.55;
rr11=rr1*1.05;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));

num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
  m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;

%end;


%if &type. eq poismix3 or &type. eq poismix1 or &type. eq poismix3 or &type. eq gammamix1 or &type. eq gammamix2 or &type. eq gammamix2 %then %do;
keep num_event lrisk num_bs group group2;
%end;
%else %do;
keep num_event lrisk num_bs group;
%end;
 run;  


proc sort data=event1_&m.;
by group;
run;


/*P-value for superiority test need to divide by 2 */
/*Estimate and 95% CI the same */
	 ods listing ;
ods output Estimates=est_group_&m.; 
PROC genmod DATA=event1_&m. order=data;
  CLASS group;
  MODEL num_event =group num_bs
       /DIST= negbin link=log/* ZIP P*/   offset=lrisk ;*TYPE3 WALD;
  lsmeans group /  cl;     
 estimate 'test-active' group 1 -1  /exp;      
       run;
 %if &m. eq 1 %then %do;      
 data summary;
   set est_group_&m.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%else  %if &m. ne 1 %then %do;      
 data summary;
   set est_group_&m. summary;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%end;
proc sql noprint;
create table summary1 as 
  select sum(ind_ni)/sum(order) as pct_ni
	,sum(ind_sup)/sum(order) as pct_sup,label 
	from summary
	where ind_ni ne . and ind_sup ne .
	group by label;
	quit;
%mend sim_binom;

%sim_binom(N=3000,K=1000, rr_trt=1,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff1); 


%macro sim_binom(N=,K= , rr_trt=,lambda_baseline=,op=,mar_ni=, type=,miss=)/minoperator;
/* N sample size                             *
 * repeat number for simulation K            *
 * group, treatment group-categorical with values   *
 * 1-test drug group  2-active comparator drug group *
 * rr_trt recurrent event rate ratio between test drug group and active comparator drug group *
 * lambda_baseline the mean recurrent event number assuming Poisson distribution              *  
 * mar_ni non-inferiority margin of rate ratio between test drug group and active comparator drug group *
 * op-overdispersion parameter in negative binomial model *
 * type-different types of NB model assumption violations *
 * miss-different types of missing patterns * /
 /*generate baseline event number in the past time duration with T=1 year */
 /*assume Poisson distribution with lamda=lambda_baseline */
%do m=1 %to &K;

data baseline_&m.;
   m1=&lambda_baseline.;
    %do j= 1 %to &N/2;
      group=1;
      num_bs=rand('POISSON',m1);
	  output;
   %end;
 %do j= &N/2+1 %to &N;
      group=2;
      num_bs=rand('POISSON',m1);
	  output;
   %end;


keep num_bs; 

keep group;
 run;
 data event1_&m.;
  set baseline_&m.;
   rr1=&rr_trt.;
   if group eq 1 then group_i=1;
   else if group eq 2 then group_i=0;

 m_event=exp(-0.5+0.39*num_bs+group_i*log(rr1));


  lrisk=log(365.25);
%if &type. eq negbio %then %do;
 alpha=1/&op;
 beta=m_event*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta*rangam(seed,alpha);
num_event=rand('POISSON',gamma);
%end;
%else %if &type. eq pois %then %do;
num_event=rand('POISSON',m_event);
%end;

%else %if &type. eq gammamix3 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*0.95;
rr12=rr1*1.45;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;
%else %if &type. eq rdiff1 %then %do;
alpha=1/&op.;
rr11=0.8*rr1;
rr12=1.2*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.25+0.39*num_bs1+group_i*log(rr11));
  beta1=0.5*m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.25+0.39*num_bs2+group_i*log(rr12));
  beta2=0.5*m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff2 %then %do;
alpha=1/&op.;
rr11=1.2*rr1;
rr12=0.8*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.25+0.39*num_bs1+group_i*log(rr11));
  beta1=0.5*m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.25+0.39*num_bs2+group_i*log(rr12));
  beta2=0.5*m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq rdiff0 %then %do;
alpha=1/&op.;
rr11=1.0*rr1;
rr12=1.0*rr1;
num_bs1=num_bs/2;
m_event1=exp(-0.25+0.39*num_bs1+group_i*log(rr11));
beta1=m_event1*&op.;  
seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.25+0.39*num_bs2+group_i*log(rr12));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq rdiff00 %then %do;
alpha=1/&op.;
rr11=1.0*rr1;
rr12=1.0*rr1;
rr13=1.0*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);





num_event=num_event2+num_event1;
%end;



%else %if &type. eq gammamix2 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*0.9;
rr12=rr1*1.9;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;
%else %if &type. eq gammamix1 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*1.2;
rr12=rr1*0.8;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;



%else %if &type. eq poismix1 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.5);
 %end;
rr11=rr1*1.2;
rr12=rr1*0.8;
 if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;
%end;
%else %if &type. eq poismix2 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.1);
 %end;
rr11=rr1*0.8;
rr12=rr1*2.8;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
  m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;
%end;
%else %if &type. eq poismix3 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
rr12=rr1*0.55;
rr11=rr1*1.05;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));

num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
  m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;

%end;


%if &type. eq poismix3 or &type. eq poismix1 or &type. eq poismix3 or &type. eq gammamix1 or &type. eq gammamix2 or &type. eq gammamix2 %then %do;
keep num_event lrisk num_bs group group2;
%end;
%else %do;
keep num_event lrisk num_bs group;
%end;
 run;  


proc sort data=event1_&m.;
by group;
run;


/*P-value for superiority test need to divide by 2 */
/*Estimate and 95% CI the same */
	 ods listing ;
ods output Estimates=est_group_&m.; 
PROC genmod DATA=event1_&m. order=data;
  CLASS group;
  MODEL num_event =group num_bs
       /DIST= negbin link=log/* ZIP P*/   offset=lrisk ;*TYPE3 WALD;
  lsmeans group /  cl;     
 estimate 'test-active' group 1 -1  /exp;      
       run;
 %if &m. eq 1 %then %do;      
 data summary;
   set est_group_&m.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%else  %if &m. ne 1 %then %do;      
 data summary;
   set est_group_&m. summary;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%end;
proc sql noprint;
create table summary1 as 
  select sum(ind_ni)/sum(order) as pct_ni
	,sum(ind_sup)/sum(order) as pct_sup,label 
	from summary
	where ind_ni ne . and ind_sup ne .
	group by label;
	quit;
%mend sim_binom;

%sim_binom(N=3000,K=1000, rr_trt=1,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff0,seq=); 

%macro sim_binom(N=,K= , rr_trt=,lambda_baseline=,op=,mar_ni=, type=,miss=,seq=)/minoperator;
/* N sample size                             *
 * repeat number for simulation K            *
 * group, treatment group-categorical with values   *
 * 1-test drug group  2-active comparator drug group *
 * rr_trt recurrent event rate ratio between test drug group and active comparator drug group *
 * lambda_baseline the mean recurrent event number assuming Poisson distribution              *  
 * mar_ni non-inferiority margin of rate ratio between test drug group and active comparator drug group *
 * op-overdispersion parameter in negative binomial model *
 * type-different types of NB model assumption violations *
 * miss-different types of missing patterns *
 * seq- separate different simulation types in the files generated within the macro * /
 /*generate baseline event number in the past time duration with T=1 year */
 /*assume Poisson distribution with lamda=lambda_baseline */
%do m=1 %to &K;

data baseline_&m._&seq.;
   m1=&lambda_baseline.;
    %do j= 1 %to &N/2;
      group=1;
      num_bs=rand('POISSON',m1);
	  output;
   %end;
 %do j= &N/2+1 %to &N;
      group=2;
      num_bs=rand('POISSON',m1);
	  output;
   %end;
keep num_bs; 
keep group;
 run;
 
 
data event1_&m._&seq.;
  set baseline_&m._&seq.;
   rr1=&rr_trt.;
   if group eq 1 then group_i=1;
   else if group eq 2 then group_i=0;
 m_event=exp(-0.5+0.39*num_bs+group_i*log(rr1));
lrisk=log(365.25);
%if &type. eq negbio %then %do;
 alpha=1/&op;
 beta=m_event*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta*rangam(seed,alpha);
num_event=rand('POISSON',gamma);
%end;
%else %if &type. eq pois %then %do;
num_event=rand('POISSON',m_event);
%end;
%else %if &type. eq rdiff0pois %then %do;
rr11=1.0*rr1;
rr12=1.0*rr1;
num_bs1=num_bs/2;
m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff2pois %then %do;
rr11=1.2*rr1;
rr12=0.8*rr1;
num_bs1=num_bs/2;
m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff1pois %then %do;
rr11=0.8*rr1;
rr12=1.2*rr1;
num_bs1=num_bs/2;
m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;



%else %if &type. eq gammamix3 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*0.95;
rr12=rr1*1.45;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;
%else %if &type. eq rdiff1 %then %do;
alpha=1/&op.;
rr11=0.8*rr1;
rr12=1.2*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff2 %then %do;
alpha=1/&op.;
rr11=1.2*rr1;
rr12=0.8*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq rdiff0 %then %do;
alpha=1/&op.;
rr11=1.0*rr1;
rr12=1.0*rr1;
num_bs1=num_bs/2;
m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
beta1=m_event1*&op.;  
seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq rdiff00 %then %do;
alpha=1/&op.;
rr11=1.0*rr1;
rr12=1.0*rr1;
rr13=1.0*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);





num_event=num_event2+num_event1;
%end;



%else %if &type. eq gammamix2 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*0.9;
rr12=rr1*1.9;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;
%else %if &type. eq gammamix1 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*1.2;
rr12=rr1*0.8;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;



%else %if &type. eq poismix1 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.5);
 %end;
rr11=rr1*1.2;
rr12=rr1*0.8;
 if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;
%end;
%else %if &type. eq poismix2 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.1);
 %end;
rr11=rr1*0.8;
rr12=rr1*2.8;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
  m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;
%end;
%else %if &type. eq poismix3 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
rr12=rr1*0.55;
rr11=rr1*1.05;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));

num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
  m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;

%end;


%if &type. eq poismix3 or &type. eq poismix1 or &type. eq poismix3 or &type. eq gammamix1 or &type. eq gammamix2 or &type. eq gammamix2 %then %do;
keep num_event lrisk num_bs group group2;
%end;
%else %do;
keep num_event lrisk num_bs group;
%end;
 run;  


proc sort data=event1_&m._&seq.;
by group;
run;


/*P-value for superiority test need to divide by 2 */
/*Estimate and 95% CI the same */
	 ods listing ;
ods output Estimates=est_group_&m._&seq.; 
PROC genmod DATA=event1_&m._&seq. order=data;
  CLASS group;
  MODEL num_event =group num_bs
       /DIST= negbin link=log/* ZIP P*/   offset=lrisk ;*TYPE3 WALD;
  lsmeans group /  cl;     
 estimate 'test-active' group 1 -1  /exp;      
       run;
 %if &m. eq 1 %then %do;      
 data summary_&seq.;
   set est_group_&m._&seq.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%else  %if &m. ne 1 %then %do;      
 data summary_&seq.;
   set est_group_&m._&seq. summary_&seq.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%end;
proc sql noprint;
create table summary1_&seq. as 
  select sum(ind_ni)/sum(order) as pct_ni
	,sum(ind_sup)/sum(order) as pct_sup,label 
	from summary_&seq.
	where ind_ni ne . and ind_sup ne .
	group by label;
	quit;
%mend sim_binom;

%sim_binom(N=3000,K=2, rr_trt=0.95,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff0,seq=1);  














/* missing completely at random pattern 1 10% dropout at both treatment groups*/  
  %if &miss. eq 101 %then %do;    
      group11=rand('BERNOULLI',0.9);
        if group11 eq 0 then do;
          group12=rand('BERNOULLI',0.4); 
          end;
           if group12 eq 0 then do;
             group13=rand('BERNOULLI',0.5); 
             end;
             if group13 eq 0 then do;
               group14=rand('BERNOULLI',2/3);   
                 end;
   %end;
   %else %if &miss. eq 102 %then %do;
    if group eq 2 then do;    
      group11=rand('BERNOULLI',0.8);
        end;
        if group11 eq 0 and group eq 2 then do;
          group12=rand('BERNOULLI',0.35); 
          end;
           if group12 eq 0 and group eq 2 then do;
             group13=rand('BERNOULLI',6/13); 
             end;
             if group13 eq 0 and group eq 2 then do;
               group14=rand('BERNOULLI',4/7);
                 end;   
                  if group eq 1 then do;    
      group11=rand('BERNOULLI',0.9);
        end;
        if group11 eq 0 and group eq 1 then do;
          group12=rand('BERNOULLI',0.4); 
          end;
           if group12 eq 0 and group eq 1 then do;
             group13=rand('BERNOULLI',0.5); 
             end;
             if group13 eq 0 and group eq 1 then do;
               group14=rand('BERNOULLI',2/3);
                 end;  
   %end;
     %else %if &miss. eq 103 %then %do;
    if group eq 1 then do;    
      group11=rand('BERNOULLI',0.8);
        end;
        if group11 eq 0 and group eq 1 then do;
          group12=rand('BERNOULLI',0.35); 
          end;
           if group12 eq 0 and group eq 1 then do;
             group13=rand('BERNOULLI',6/13); 
             end;
             if group13 eq 0 and group eq 1 then do;
               group14=rand('BERNOULLI',4/7);
                 end;   
                  if group eq 2 then do;    
      group11=rand('BERNOULLI',0.9);
        end;
        if group11 eq 0 and group eq 2 then do;
          group12=rand('BERNOULLI',0.4); 
          end;
           if group12 eq 0 and group eq 2 then do;
             group13=rand('BERNOULLI',0.5); 
             end;
             if group13 eq 0 and group eq 2 then do;
               group14=rand('BERNOULLI',2/3);
                 end;  
   %end;
   
   
   
    %else %if &miss. eq 104 %then %do;  
      group11=rand('BERNOULLI',0.7);
        if group11 eq 0 then do;
          group12=rand('BERNOULLI',0.4); 
          end;
           if group12 eq 0 then do;
             group13=rand('BERNOULLI',4/9); 
             end;
             if group13 eq 0 then do;
               group14=rand('BERNOULLI',0.5);  
                 end; 
   %end;  
        %else %if &miss. eq 201 %then %do;
     if num_bs ge 3 then do;     
      group11=rand('BERNOULLI',0.8);
      end;
        if group11 eq 0 and num_bs ge 3  then do;
          group12=rand('BERNOULLI',0.35); 
          end;
           if group12 eq 0 and num_bs ge 3  then do;
             group13=rand('BERNOULLI',6/13); 
             end;
             if group13 eq 0 and num_bs ge 3  then do;
               group14=rand('BERNOULLI',4/7);
                 end;    
      %end;
           %else %if &miss. eq 202 %then %do;
     if num_bs ge 3 and group eq 1 then do;     
      group11=rand('BERNOULLI',0.8);
      end;
        if group11 eq 0 and num_bs ge 3 and group eq 1 then do;
          group12=rand('BERNOULLI',0.35); 
          end;
           if group12 eq 0 and num_bs ge 3 and group eq 1  then do;
             group13=rand('BERNOULLI',6/13); 
             end;
             if group13 eq 0 and num_bs ge 3 and group eq 1 then do;
               group14=rand('BERNOULLI',4/7);
                 end;    
                  if num_bs lt 3 and group eq 2 then do;     
      group11=rand('BERNOULLI',0.8);
      end;
        if group11 eq 0 and num_bs lt 3 and group eq 2 then do;
          group12=rand('BERNOULLI',0.35); 
          end;
           if group12 eq 0 and num_bs lt 3 and group eq 2  then do;
             group13=rand('BERNOULLI',6/13); 
             end;
             if group13 eq 0 and num_bs lt 3 and group eq 2 then do;
               group14=rand('BERNOULLI',4/7);
                 end;    
      %end; 
                %else %if &miss. eq 203 %then %do;
     if num_bs ge 3 and group eq 2 then do;     
      group11=rand('BERNOULLI',0.8);
      end;
        if group11 eq 0 and num_bs ge 3 and group eq 2 then do;
          group12=rand('BERNOULLI',0.35); 
          end;
           if group12 eq 0 and num_bs ge 3 and group eq 2  then do;
             group13=rand('BERNOULLI',6/13); 
             end;
             if group13 eq 0 and num_bs ge 3 and group eq 2 then do;
               group14=rand('BERNOULLI',4/7);
                 end;    
                  if num_bs lt 3 and group eq 1 then do;     
      group11=rand('BERNOULLI',0.8);
      end;
        if group11 eq 0 and num_bs lt 3 and group eq 1 then do;
          group12=rand('BERNOULLI',0.35); 
          end;
           if group12 eq 0 and num_bs lt 3 and group eq 1  then do;
             group13=rand('BERNOULLI',6/13); 
             end;
             if group13 eq 0 and num_bs lt 3 and group eq 1 then do;
               group14=rand('BERNOULLI',4/7);
                 end;    
      %end; 
 
 
 
           
/* 11182013 *
 * superiority type I error 0.014 Non-inferiority power 0.625 by rdiff2 rr=1 *
 * superiority type I error 0.096 Non-inferiority power 0.917 by rdiff1 rr=1 *
  * superiority type I error 0 Non-inferiority power 0.263 by rdiff1 rr=1.1 * 
    * superiority type I error 0 Non-inferiority power 0.036 by rdiff2 rr=1.1 * 
        * superiority type I error 0 Non-inferiority power 0.23 by rdiff2 rr=1.05 *   
   * superiority type I error 0.008 Non-inferiority power 0.623 by rdiff1 rr=1.05 *  
* superiority POWER 0.821 Non-inferiority type I error 0 by rdiff1 rr=0.9 *   
   * superiority POWER 0.797 Non-inferiority type I error 0.001 by rdiff2 rr=0.9 * 
      * superiority POWER 0.599 Non-inferiority type I error 0.004 by rdiff0 rr=0.9 *      
      
      
      
%sim_binom(N=3000,K=1000, rr_trt=1,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff0,seq=); 

%macro sim_binom(N=,K= , rr_trt=,lambda_baseline=,op=,mar_ni=, type=,miss=,seq=)/minoperator;
/* N sample size                             *
 * repeat number for simulation K            *
 * group, treatment group-categorical with values   *
 * 1-test drug group  2-active comparator drug group *
 * rr_trt recurrent event rate ratio between test drug group and active comparator drug group *
 * lambda_baseline the mean recurrent event number assuming Poisson distribution              *  
 * mar_ni non-inferiority margin of rate ratio between test drug group and active comparator drug group *
 * op-overdispersion parameter in negative binomial model *
 * type-different types of NB model assumption violations *
 * miss-different types of missing patterns *
 * seq- separate different simulation types in the files generated within the macro * /
 /*generate baseline event number in the past time duration with T=1 year */
 /*assume Poisson distribution with lamda=lambda_baseline */
%do m=1 %to &K;

data baseline_&m._&seq.;
   m1=&lambda_baseline.;
    %do j= 1 %to &N/2;
      group=1;
      num_bs=rand('POISSON',m1);
	  output;
   %end;
 %do j= &N/2+1 %to &N;
      group=2;
      num_bs=rand('POISSON',m1);
	  output;
   %end;
keep num_bs; 
keep group;
 run;
 
 
data event1_&m._&seq.;
  set baseline_&m._&seq.;
   rr1=&rr_trt.;
   if group eq 1 then group_i=1;
   else if group eq 2 then group_i=0;
 m_event=exp(-0.5+0.39*num_bs+group_i*log(rr1));
lrisk=log(365.25);
%if &type. eq negbio %then %do;
 alpha=1/&op;
 beta=m_event*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta*rangam(seed,alpha);
num_event=rand('POISSON',gamma);
%end;
%else %if &type. eq pois %then %do;
num_event=rand('POISSON',m_event);
%end;
%else %if &type. eq rdiff0pois %then %do;
rr11=1.0*rr1;
rr12=1.0*rr1;
num_bs1=num_bs/2;
m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff2pois %then %do;
rr11=1.2*rr1;
rr12=0.8*rr1;
num_bs1=num_bs/2;
m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff1pois %then %do;
rr11=0.8*rr1;
rr12=1.2*rr1;
num_bs1=num_bs/2;
m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;



%else %if &type. eq gammamix3 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*0.95;
rr12=rr1*1.45;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;
%else %if &type. eq rdiff1 %then %do;
alpha=1/&op.;
rr11=0.8*rr1;
rr12=1.2*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff2 %then %do;
alpha=1/&op.;
rr11=1.2*rr1;
rr12=0.8*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq rdiff0 %then %do;
alpha=1/&op.;
rr11=1.0*rr1;
rr12=1.0*rr1;
num_bs1=num_bs/2;
m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
beta1=m_event1*&op.;  
seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq rdiff00 %then %do;
alpha=1/&op.;
rr11=1.0*rr1;
rr12=1.0*rr1;
rr13=1.0*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);





num_event=num_event2+num_event1;
%end;



%else %if &type. eq gammamix2 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*0.9;
rr12=rr1*1.9;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;
%else %if &type. eq gammamix1 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*1.2;
rr12=rr1*0.8;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;



%else %if &type. eq poismix1 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.5);
 %end;
rr11=rr1*1.2;
rr12=rr1*0.8;
 if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;
%end;
%else %if &type. eq poismix2 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.1);
 %end;
rr11=rr1*0.8;
rr12=rr1*2.8;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
  m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;
%end;
%else %if &type. eq poismix3 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
rr12=rr1*0.55;
rr11=rr1*1.05;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));

num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
  m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;

%end;


%if &type. eq poismix3 or &type. eq poismix1 or &type. eq poismix3 or &type. eq gammamix1 or &type. eq gammamix2 or &type. eq gammamix3 %then %do;
keep num_event lrisk num_bs group group2;
%end;
%else %do;
keep num_event lrisk num_bs group;
%end;
 run;  


proc sort data=event1_&m._&seq.;
by group;
run;


/*P-value for superiority test need to divide by 2 */
/*Estimate and 95% CI the same */
	 ods listing ;
ods output Estimates=est_group_&m._&seq.; 
PROC genmod DATA=event1_&m._&seq. noprint;
  CLASS group;
  MODEL num_event =group num_bs
  %if &type. eq rdiff0pois or &type. eq rdiff1pois or &type. eq rdiff2pois or &type. eq pois or & type. eq poismix1 or &type. eq poismix2 or &type. eq poismix3 %then %do;
  /DIST= Poisson link=log   offset=lrisk ;*TYPE3 WALD;
  %end;
  %else %do;
       /DIST= negbin link=log   offset=lrisk ;*TYPE3 WALD;
       %end;
  lsmeans group /  cl;     
 estimate 'test-active' group 1 -1  /exp;      
       run;
 %if &m. eq 1 %then %do;      
 data summary_&seq.;
   set est_group_&m._&seq.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%else  %if &m. ne 1 %then %do;      
 data summary_&seq.;
   set est_group_&m._&seq. summary_&seq.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%end;
proc sql noprint;
create table summary1_&seq. as 
  select sum(ind_ni)/sum(order) as pct_ni
	,sum(ind_sup)/sum(order) as pct_sup,label 
	from summary_&seq.
	where ind_ni ne . and ind_sup ne .
	group by label;
	quit;
%mend sim_binom;

%sim_binom(N=3000,K=1000, rr_trt=1,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff0pois,seq=1);  
%sim_binom(N=3000,K=1000, rr_trt=1,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff1pois,seq=2); 
%sim_binom(N=3000,K=1000, rr_trt=1,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff2pois,seq=3);   
%sim_binom(N=3000,K=1000, rr_trt=1.15,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff0pois,seq=4);  
%sim_binom(N=3000,K=1000, rr_trt=1.15,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff1pois,seq=5); 
%sim_binom(N=3000,K=1000, rr_trt=1.15,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff2pois,seq=6); 
%sim_binom(N=3000,K=1000, rr_trt=0.85,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff0pois,seq=7);  
%sim_binom(N=3000,K=1000, rr_trt=0.85,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff1pois,seq=8); 
%sim_binom(N=3000,K=1000, rr_trt=0.85,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff2pois,seq=9);
%sim_binom(N=3000,K=1000, rr_trt=1.1,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff0pois,seq=10);  
%sim_binom(N=3000,K=1000, rr_trt=1.1,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff1pois,seq=11); 
%sim_binom(N=3000,K=1000, rr_trt=1.1,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff2pois,seq=12); 

/* 11192013 *
 * superiority type I error 0.028 Non-inferiority power 0.872 by rdiff0pois rr=1 *
 * superiority type I error 0.102 Non-inferiority power 0.956 by rdiff1pois rr=1 *
  * superiority type I error 0.009 Non-inferiority power 0.722 by rdiff2pois rr=1 *
   * superiority type I error 0  Non-inferiority type I error 0.011 by rdiff0pois rr=1.15 *
 * superiority type I error 0 Non-inferiority type I error 0.07 by rdiff1pois rr=1.15 *
  * superiority type I error 0 Non-inferiority type I error 0.002 by rdiff2pois rr=1.15 * 
  * superiority power 0.949 Non-inferiority type I error 0 by rdiff0pois rr=0.9 *
 * superiority power 0.987 Non-inferiority type I error 0 by rdiff1pois rr=0.9 *
 * superiority power 0.891 Non-inferiority type I error 0 by rdiff2pois rr=0.9 * 
 * superiority type I error 0 Non-inferiority POWER 0.11 by rdiff0pois rr=1.1 *
 * superiority type I error 0 Non-inferiority POWER 0.31 by rdiff1pois rr=1.1 *
  * superiority type I error 0 Non-inferiority POWER 0.054 by rdiff2pois rr=1.1
   * /  
   
   
   /* 11202013 *
 * superiority type I error 0.042 Non-inferiority power 0.903 by rdiff0pois rr=1 apply poisson regression  *
 * superiority type I error 0.127 Non-inferiority power 0.972 by rdiff1pois rr=1 apply poisson regression*
  * superiority type I error 0.006 Non-inferiority power 0.783 by rdiff2pois rr=1 apply poisson regression*         
   * superiority type I error 0.001 Non-inferiority power 0.558 by rdiff0pois rr=1.05 apply poisson regression  *  
    * superiority type I error 0.014 Non-inferiority power 0.767 by rdiff1pois rr=1.05 apply poisson regression  * 
     * superiority type I error 0 Non-inferiority power 0.351 by rdiff2pois rr=1.05 apply poisson regression  *  
     * superiority type I error 0 Non-inferiority power 0.148 by rdiff0pois rr=1.1 apply poisson regression  * 
      * superiority type I error 0 Non-inferiority power 0.375 by rdiff1pois rr=1.1 apply poisson regression  *          
      * superiority type I error 0 Non-inferiority power 0.067 by rdiff2pois rr=1.1 apply poisson regression  *       
      * superiority power 0.289 Non-inferiority power 0.997 by rdiff0pois rr=0.95 apply poisson regression  * 
      * superiority power 0.548 Non-inferiority power 1 by rdiff1pois rr=0.95 apply poisson regression  *          
      * superiority power 0.134 Non-inferiority power 0.98 by rdiff2pois rr=0.95 apply poisson regression  * 
      * superiority power 0.75 Non-inferiority power 1 by rdiff0pois rr=0.9 apply poisson regression  * 
      * superiority power 0.906 Non-inferiority power 1 by rdiff0pois rr=0.9 apply poisson regression  *          
      * superiority power 0.535 Non-inferiority power 0.998 by rdiff2pois rr=0.9 apply poisson regression  * 
    * superiority type I error 0 Non-inferiority type I error 0.006 by rdiff0pois rr=1.15 apply poisson regression  *
 * superiority type I error 0 Non-inferiority type I error 0.074 by rdiff1pois rr=1.15 apply poisson regression*
  * superiority type I error 0 Non-inferiority type I error 0.005 by rdiff2pois rr=1.15 apply poisson regression*   
     * superiority type I error 0 Non-inferiority type I error 0 by rdiff0pois rr=1.2 apply poisson regression  *
 * superiority type I error 0 Non-inferiority type I error 0.009 by rdiff1pois rr=1.2 apply poisson regression*
  * superiority type I error 0 Non-inferiority type I error 0 by rdiff2pois rr=1.2 apply poisson regression* 
  /* 11182013 *
 * superiority type I error 0.014 Non-inferiority power 0.625 by rdiff2 rr=1 *
 * superiority type I error 0.096 Non-inferiority power 0.917 by rdiff1 rr=1 *
  * superiority type I error 0 Non-inferiority power 0.263 by rdiff1 rr=1.1 * 
    * superiority type I error 0 Non-inferiority power 0.036 by rdiff2 rr=1.1 * 
        * superiority type I error 0 Non-inferiority power 0.23 by rdiff2 rr=1.05 *   
   * superiority type I error 0.008 Non-inferiority power 0.623 by rdiff1 rr=1.05 *  
* superiority POWER 0.821 Non-inferiority type I error 0 by rdiff1 rr=0.9 *   
   * superiority POWER 0.797 Non-inferiority type I error 0.001 by rdiff2 rr=0.9 * 
      * superiority POWER 0.599 Non-inferiority type I error 0.004 by rdiff0 rr=0.9 *  
  options nomprint;

%macro sim_binom(N=,K= , rr_trt=,lambda_baseline=,op=,mar_ni=, type=,miss=,seq=)/minoperator;
/* N sample size                             *
 * repeat number for simulation K            *
 * group, treatment group-categorical with values   *
 * 1-test drug group  2-active comparator drug group *
 * rr_trt recurrent event rate ratio between test drug group and active comparator drug group *
 * lambda_baseline the mean recurrent event number assuming Poisson distribution              *  
 * mar_ni non-inferiority margin of rate ratio between test drug group and active comparator drug group *
 * op-overdispersion parameter in negative binomial model *
 * type-different types of NB model assumption violations *
 * miss-different types of missing patterns *
 * seq- separate different simulation types in the files generated within the macro * /
 /*generate baseline event number in the past time duration with T=1 year */
 /*assume Poisson distribution with lamda=lambda_baseline */
%do m=1 %to &K;

data baseline_&m._&seq.;
   m1=&lambda_baseline.;
    %do j= 1 %to &N/2;
      group=1;
      num_bs=rand('POISSON',m1);
	  output;
   %end;
 %do j= &N/2+1 %to &N;
      group=2;
      num_bs=rand('POISSON',m1);
	  output;
   %end;
keep num_bs; 
keep group;
 run;
 
 
data event1_&m._&seq.;
  set baseline_&m._&seq.;
   rr1=&rr_trt.;
   if group eq 1 then group_i=1;
   else if group eq 2 then group_i=0;
 m_event=exp(-0.5+0.39*num_bs+group_i*log(rr1));
lrisk=log(365.25);
%if &type. eq negbio %then %do;
 alpha=1/&op;
 beta=m_event*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta*rangam(seed,alpha);
num_event=rand('POISSON',gamma);
%end;
%else %if &type. eq pois %then %do;
num_event=rand('POISSON',m_event);
%end;
%else %if &type. eq rdiff0pois %then %do;
rr11=1.0*rr1;
rr12=1.0*rr1;
num_bs1=num_bs/2;
m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff2pois %then %do;
rr11=1.2*rr1;
rr12=0.8*rr1;
num_bs1=num_bs/2;
m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff1pois %then %do;
rr11=0.8*rr1;
rr12=1.2*rr1;
num_bs1=num_bs/2;
m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;



%else %if &type. eq gammamix3 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*0.95;
rr12=rr1*1.45;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;
%else %if &type. eq rdiff1 %then %do;
alpha=1/&op.;
rr11=0.8*rr1;
rr12=1.2*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff2 %then %do;
alpha=1/&op.;
rr11=1.2*rr1;
rr12=0.8*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq rdiff0 %then %do;
alpha=1/&op.;
rr11=1.0*rr1;
rr12=1.0*rr1;
num_bs1=num_bs/2;
m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11)-LOG(2));
beta1=m_event1*&op.;  
seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq rdiff00 %then %do;
alpha=1/&op.;
rr11=1.0*rr1;
rr12=1.0*rr1;
rr13=1.0*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);





num_event=num_event2+num_event1;
%end;



%else %if &type. eq gammamix2 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*0.9;
rr12=rr1*1.9;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;
%else %if &type. eq gammamix1 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
alpha=1/&op;
rr11=rr1*1.2;
rr12=rr1*0.8;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
 beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta1*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
else if group2 eq 0 then do;
 m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
 beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta2*rangam(seed,alpha);
num_event=rand('POISSON',gamma); 
end;
%end;



%else %if &type. eq poismix1 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.5);
 %end;
rr11=rr1*1.2;
rr12=rr1*0.8;
 if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;
%end;
%else %if &type. eq poismix2 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.1);
 %end;
rr11=rr1*0.8;
rr12=rr1*2.8;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));
num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
  m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;
%end;
%else %if &type. eq poismix3 %then %do;
 %do j=1 %to &N;
 group2=rand('BERNOULLI',0.9);
 %end;
rr12=rr1*0.55;
rr11=rr1*1.05;
if group2 eq 1 then do;
 m_event1=exp(-0.5+0.39*num_bs+group_i*log(rr11));

num_event=rand('POISSON',m_event1);
end;
else if group2 eq 0 then do;
  m_event2=exp(-0.5+0.39*num_bs+group_i*log(rr12));
num_event=rand('POISSON',m_event2);
end;

%end;


%if &type. eq poismix3 or &type. eq poismix1 or &type. eq poismix3 or &type. eq gammamix1 or &type. eq gammamix2 or &type. eq gammamix3 %then %do;
keep num_event lrisk num_bs group group2;
%end;
%else %do;
keep num_event lrisk num_bs group;
%end;
 run;  


proc sort data=event1_&m._&seq.;
by group;
run;


/*P-value for superiority test need to divide by 2 */
/*Estimate and 95% CI the same */
ODS SELECT NONE;
ODS listing;
ods output Estimates=est_group_&m._&seq.; 
PROC genmod DATA=event1_&m._&seq. ;
  CLASS group;
  MODEL num_event =group num_bs
  %if &type. eq rdiff0pois or &type. eq rdiff1pois or &type. eq rdiff2pois or &type. eq pois or &type. eq poismix1 or &type. eq poismix2 or &type. eq poismix3 %then %do;
  /DIST= Poisson link=log   offset=lrisk ;*TYPE3 WALD;
  %end;
  %else %do;
       /DIST= negbin link=log   offset=lrisk ;*TYPE3 WALD;
       %end;
  lsmeans group /  cl;     
 estimate 'test-active' group 1 -1  /exp;      
       run;
 %if &m. eq 1 %then %do;      
 data summary_&seq.;
   set est_group_&m._&seq.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%else  %if &m. ne 1 %then %do;      
 data summary_&seq.;
   set est_group_&m._&seq. summary_&seq.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%end;
proc sql noprint;
create table summary1_&seq. as 
  select sum(ind_ni)/sum(order) as pct_ni
	,sum(ind_sup)/sum(order) as pct_sup,label 
	from summary_&seq.
	where ind_ni ne . and ind_sup ne .
	group by label;
	quit;
%mend sim_binom;

%sim_binom(N=3000,K=1000, rr_trt=1.15,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff2pois,seq=1);  
%sim_binom(N=3000,K=1000, rr_trt=1.15,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff1pois,seq=2); 
%sim_binom(N=3000,K=1000, rr_trt=1.15,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff2pois,seq=3);

options nomprint;
/*with a very weak dependence of exacerbation based on exacerbation history */
%macro sim_binom2(N=,K= , rr_trt=,lambda_baseline=,op=,mar_ni=, type=,miss=,seq=)/minoperator;
/* N sample size                             *
 * repeat number for simulation K            *
 * group, treatment group-categorical with values   *
 * 1-test drug group  2-active comparator drug group *
 * rr_trt recurrent event rate ratio between test drug group and active comparator drug group *
 * lambda_baseline the mean recurrent event number assuming Poisson distribution              *  
 * mar_ni non-inferiority margin of rate ratio between test drug group and active comparator drug group *
 * op-overdispersion parameter in negative binomial model *
 * type-different types of NB model assumption violations *
 * miss-different types of missing patterns *
 * seq- separate different simulation types in the files generated within the macro * /
 /*generate baseline event number in the past time duration with T=1 year */
 /*assume Poisson distribution with lamda=lambda_baseline */
%do m=1 %to &K;

data baseline_&m._&seq.;
   m1=&lambda_baseline./2;
    %do j= 1 %to &N/2;
      group=1;
      num_bs1=rand('POISSON',m1);
      num_bs2=rand('POISSON',m1);
	  output;
   %end;
 %do j= &N/2+1 %to &N;
      group=2;
      num_bs1=rand('POISSON',m1);
      num_bs2=rand('POISSON',m1);
	  output;
   %end;
keep num_bs; 
keep group;
 run;
 
 
data event1_&m._&seq.;
  set baseline_&m._&seq.;
   rr1=&rr_trt.;
   if group eq 1 then group_i=1;
   else if group eq 2 then group_i=0;

lrisk=log(365.25);
%if &type. eq negbio %then %do;
 alpha=1/&op;
 num_bs=num_bs1+num_bs2;
  m_event=exp(-0.5+0.15*num_bs+group_i*log(rr1));
 beta=m_event*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta*rangam(seed,alpha);
num_event=rand('POISSON',gamma);
%end;
%else %if &type. eq pois %then %do;
 num_bs=num_bs1+num_bs2;
  m_event=exp(-0.5+0.15*num_bs+group_i*log(rr1));
num_event=rand('POISSON',m_event);
%end;
%else %if &type. eq rdiff0pois %then %do;
rr11=1.0*rr1;
rr12=1.0*rr1;
m_event1=exp(-0.5+0.15*num_bs1+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff2pois %then %do;
rr11=1.2*rr1;
rr12=0.8*rr1;

m_event1=exp(-0.5+0.15*num_bs1+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff1pois %then %do;
rr11=0.8*rr1;
rr12=1.2*rr1;
m_event1=exp(-0.5+0.15*num_bs1+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;




%else %if &type. eq rdiff1 %then %do;
alpha=1/&op.;
rr11=0.8*rr1;
rr12=1.2*rr1;
 m_event1=exp(-0.5+0.15*num_bs1+group_i*log(rr11)-LOG(2));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff2 %then %do;
alpha=1/&op.;
rr11=1.2*rr1;
rr12=0.8*rr1;
 m_event1=exp(-0.5+0.15*num_bs1+group_i*log(rr11)-LOG(2));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq rdiff0 %then %do;
alpha=1/&op.;
rr11=1.0*rr1;
rr12=1.0*rr1;
m_event1=exp(-0.5+0.15*num_bs1+group_i*log(rr11)-LOG(2));
beta1=m_event1*&op.;  
seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq rdiff00 %then %do;
alpha=1/&op.;
rr11=1.0*rr1;
rr12=1.0*rr1;
rr13=1.0*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;
 run;  


proc sort data=event1_&m._&seq.;
by group;
run;


/*P-value for superiority test need to divide by 2 */
/*Estimate and 95% CI the same */
ODS SELECT NONE;
ODS listing;
ods output Estimates=est_group_&m._&seq.; 
PROC genmod DATA=event1_&m._&seq. ;
  CLASS group;
  MODEL num_event =group num_bs
  %if &type. eq rdiff0pois or &type. eq rdiff1pois or &type. eq rdiff2pois or &type. eq pois or &type. eq poismix1 or &type. eq poismix2 or &type. eq poismix3 %then %do;
  /DIST= Poisson link=log   offset=lrisk ;*TYPE3 WALD;
  %end;
  %else %do;
       /DIST= negbin link=log   offset=lrisk ;*TYPE3 WALD;
       %end;
  lsmeans group /  cl;     
 estimate 'test-active' group 1 -1  /exp;      
       run;
 %if &m. eq 1 %then %do;      
 data summary_&seq.;
   set est_group_&m._&seq.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%else  %if &m. ne 1 %then %do;      
 data summary_&seq.;
   set est_group_&m._&seq. summary_&seq.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%end;
proc sql noprint;
create table summary1_&seq. as 
  select sum(ind_ni)/sum(order) as pct_ni
	,sum(ind_sup)/sum(order) as pct_sup,label 
	from summary_&seq.
	where ind_ni ne . and ind_sup ne .
	group by label;
	quit;
%mend sim_binom2;

%sim_binom(N=3000,K=1000, rr_trt=0.9,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff0,seq=1);  
%sim_binom(N=3000,K=1000, rr_trt=0.9,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff1,seq=2); 
%sim_binom(N=3000,K=1000, rr_trt=0.9,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff2,seq=3);

 options nomprint;
/*with a very weak dependence of exacerbation based on exacerbation history */
%macro sim_binom2(N=,K= , rr_trt=,lambda_baseline=,op=,mar_ni=, type=,miss=,seq=)/minoperator;
/* N sample size                             *
 * repeat number for simulation K            *
 * group, treatment group-categorical with values   *
 * 1-test drug group  2-active comparator drug group *
 * rr_trt recurrent event rate ratio between test drug group and active comparator drug group *
 * lambda_baseline the mean recurrent event number assuming Poisson distribution              *  
 * mar_ni non-inferiority margin of rate ratio between test drug group and active comparator drug group *
 * op-overdispersion parameter in negative binomial model *
 * type-different types of NB model assumption violations *
 * miss-different types of missing patterns *
 * seq- separate different simulation types in the files generated within the macro * /
 /*generate baseline event number in the past time duration with T=1 year */
 /*assume Poisson distribution with lamda=lambda_baseline */
%do m=1 %to &K;

data baseline_&m._&seq.;
   m1=&lambda_baseline./2;
    %do j= 1 %to &N/2;
      group=1;
      num_bs11=rand('POISSON',m1);
      num_bs12=rand('POISSON',m1);
	  output;
   %end;
 %do j= &N/2+1 %to &N;
      group=2;
      num_bs11=rand('POISSON',m1);
      num_bs12=rand('POISSON',m1);
	  output;
   %end;
keep num_bs11 num_bs12; 
keep group;
 run;
 
 
data event1_&m._&seq.;
  set baseline_&m._&seq.;
   rr1=&rr_trt.;
   num_bs1=num_bs11;
   if group eq 1 then group_i=1;
   else if group eq 2 then group_i=0;
 num_bs=num_bs11+num_bs12;
lrisk=log(365.25);
%if &type. eq negbio %then %do;
 alpha=1/&op;

  m_event=exp(-0.5+0.15*num_bs+group_i*log(rr1));
 beta=m_event*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta*rangam(seed,alpha);
num_event=rand('POISSON',gamma);
%end;
%else %if &type. eq pois %then %do;
  m_event=exp(-0.5+0.15*num_bs+group_i*log(rr1));
num_event=rand('POISSON',m_event);
%end;
%else %if &type. eq rdiff0pois %then %do;
rr11=1.0*rr1;
rr12=1.0*rr1;
m_event1=exp(-0.5+0.15*num_bs11+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff2pois %then %do;
rr11=1.2*rr1;
rr12=0.8*rr1;

m_event1=exp(-0.5+0.15*num_bs11+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff1pois %then %do;
rr11=0.8*rr1;
rr12=1.2*rr1;
m_event1=exp(-0.5+0.15*num_bs11+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;




%else %if &type. eq rdiff1 %then %do;
alpha=1/&op.;
rr11=0.8*rr1;
rr12=1.2*rr1;
 m_event1=exp(-0.5+0.15*num_bs1+group_i*log(rr11)-LOG(2));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff2 %then %do;
alpha=1/&op.;
rr11=1.2*rr1;
rr12=0.8*rr1;
 m_event1=exp(-0.5+0.15*num_bs1+group_i*log(rr11)-LOG(2));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq rdiff0 %then %do;
alpha=1/&op.;
rr11=1.0*rr1;
rr12=1.0*rr1;
m_event1=exp(-0.5+0.15*num_bs1+group_i*log(rr11)-LOG(2));
beta1=m_event1*&op.;  
seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq rdiff00 %then %do;
alpha=1/&op.;
rr11=1.0*rr1;
rr12=1.0*rr1;
rr13=1.0*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;
 run;  


proc sort data=event1_&m._&seq.;
by group;
run;


/*P-value for superiority test need to divide by 2 */
/*Estimate and 95% CI the same */
ODS SELECT NONE;
ODS listing;
ods output Estimates=est_group_&m._&seq.; 
PROC genmod DATA=event1_&m._&seq. ;
  CLASS group;
  MODEL num_event =group num_bs
  %if &type. eq rdiff0pois or &type. eq rdiff1pois or &type. eq rdiff2pois or &type. eq pois or &type. eq poismix1 or &type. eq poismix2 or &type. eq poismix3 %then %do;
  /DIST= Poisson link=log   offset=lrisk ;*TYPE3 WALD;
  %end;
  %else %do;
       /DIST= negbin link=log   offset=lrisk ;*TYPE3 WALD;
       %end;
  lsmeans group /  cl;     
 estimate 'test-active' group 1 -1  /exp;      
       run;
 %if &m. eq 1 %then %do;      
 data summary_&seq.;
   set est_group_&m._&seq.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%else  %if &m. ne 1 %then %do;      
 data summary_&seq.;
   set est_group_&m._&seq. summary_&seq.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%end;
proc sql noprint;
create table summary1_&seq. as 
  select sum(ind_ni)/sum(order) as pct_ni
	,sum(ind_sup)/sum(order) as pct_sup,label 
	from summary_&seq.
	where ind_ni ne . and ind_sup ne .
	group by label;
	quit;
%mend sim_binom2;

%sim_binom2(N=3000,K=1000, rr_trt=1,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff0pois,seq=1);  
%sim_binom2(N=3000,K=1000, rr_trt=1,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff1pois,seq=2); 
%sim_binom2(N=3000,K=1000, rr_trt=1,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff2pois,seq=3);
%sim_binom2(N=3000,K=1000, rr_trt=1.15,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff0pois,seq=4);  
%sim_binom2(N=3000,K=1000, rr_trt=1.15,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff1pois,seq=5); 
%sim_binom2(N=3000,K=1000, rr_trt=1.15,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff2pois,seq=6);

      do s=1 to num_event;
        p_&s.=runif       
        
        
 options nomprint;
/*with a very weak dependence of exacerbation based on exacerbation history */
%macro sim_binom2(N=,K= , rr_trt=,lambda_baseline=,op=,mar_ni=, type=,miss=,seq=)/minoperator;
/* N sample size                             *
 * repeat number for simulation K            *
 * group, treatment group-categorical with values   *
 * 1-test drug group  2-active comparator drug group *
 * rr_trt recurrent event rate ratio between test drug group and active comparator drug group *
 * lambda_baseline the mean recurrent event number assuming Poisson distribution              *  
 * mar_ni non-inferiority margin of rate ratio between test drug group and active comparator drug group *
 * op-overdispersion parameter in negative binomial model *
 * type-different types of NB model assumption violations *
 * miss-different types of missing patterns *
 * seq- separate different simulation types in the files generated within the macro * /
 /*generate baseline event number in the past time duration with T=1 year */
 /*assume Poisson distribution with lamda=lambda_baseline */
%do m=1 %to &K;

data baseline_&m._&seq.;
   m1=&lambda_baseline./2;
    %do j= 1 %to &N/2;
      group=1;
      num_bs11=rand('POISSON',m1);
      num_bs12=rand('POISSON',m1);
	  output;
   %end;
 %do j= &N/2+1 %to &N;
      group=2;
      num_bs11=rand('POISSON',m1);
      num_bs12=rand('POISSON',m1);
	  output;
   %end;
keep num_bs11 num_bs12; 
keep group;
 run;
 
 
data event1_&m._&seq.;
  set baseline_&m._&seq.;
   rr1=&rr_trt.;
   num_bs1=num_bs11;
   if group eq 1 then group_i=1;
   else if group eq 2 then group_i=0;
 num_bs=num_bs11+num_bs12;
lrisk=log(365.25);
%if &type. eq negbio %then %do;
 alpha=1/&op;

  m_event=exp(-0.5+0.15*num_bs+group_i*log(rr1));
 beta=m_event*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma=beta*rangam(seed,alpha);
num_event=rand('POISSON',gamma);
%end;
%else %if &type. eq pois %then %do;
  m_event=exp(-0.5+0.15*num_bs+group_i*log(rr1));
num_event=rand('POISSON',m_event);
%end;
%else %if &type. eq rdiff0pois %then %do;
rr11=1.0*rr1;
rr12=1.0*rr1;
m_event1=exp(-0.5+0.15*num_bs11+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff2pois %then %do;
rr11=1.2*rr1;
rr12=0.8*rr1;

m_event1=exp(-0.5+0.15*num_bs11+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff1pois %then %do;
rr11=0.8*rr1;
rr12=1.2*rr1;
m_event1=exp(-0.5+0.15*num_bs11+group_i*log(rr11)-LOG(2));
num_event1=rand('POISSON',m_event1);
num_bs2=num_event1;
m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
num_event2=rand('POISSON',m_event2);
num_event=num_event2+num_event1;
%end;




%else %if &type. eq rdiff1 %then %do;
alpha=1/&op.;
rr11=0.8*rr1;
rr12=1.2*rr1;
 m_event1=exp(-0.5+0.15*num_bs1+group_i*log(rr11)-LOG(2));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;
%else %if &type. eq rdiff2 %then %do;
alpha=1/&op.;
rr11=1.2*rr1;
rr12=0.8*rr1;
 m_event1=exp(-0.5+0.15*num_bs1+group_i*log(rr11)-LOG(2));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq rdiff0 %then %do;
alpha=1/&op.;
rr11=1.0*rr1;
rr12=1.0*rr1;
m_event1=exp(-0.5+0.15*num_bs1+group_i*log(rr11)-LOG(2));
beta1=m_event1*&op.;  
seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.15*num_bs2+group_i*log(rr12)-LOG(2));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;

%else %if &type. eq rdiff00 %then %do;
alpha=1/&op.;
rr11=1.0*rr1;
rr12=1.0*rr1;
rr13=1.0*rr1;
num_bs1=num_bs/2;
 m_event1=exp(-0.5+0.39*num_bs1+group_i*log(rr11));
  beta1=m_event1*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma1=beta1*rangam(seed,alpha);
num_event1=rand('POISSON',gamma1);
num_bs2=num_event1;
 m_event2=exp(-0.5+0.39*num_bs2+group_i*log(rr12));
  beta2=m_event2*&op.;  
  seed=int(100000*RAND('UNIFORM'))+15678;
gamma2=beta2*rangam(seed,alpha);
num_event2=rand('POISSON',gamma2);
num_event=num_event2+num_event1;
%end;
 run;  


proc sort data=event1_&m._&seq.;
by group;
run;


/*P-value for superiority test need to divide by 2 */
/*Estimate and 95% CI the same */
ODS SELECT NONE;
ODS listing;
ods output Estimates=est_group_&m._&seq.; 
PROC genmod DATA=event1_&m._&seq. ;
  CLASS group;
  MODEL num_event =group num_bs
  %if &type. eq rdiff0pois or &type. eq rdiff1pois or &type. eq rdiff2pois or &type. eq pois or &type. eq poismix1 or &type. eq poismix2 or &type. eq poismix3 %then %do;
  /DIST= Poisson link=log   offset=lrisk ;*TYPE3 WALD;
  %end;
  %else %do;
       /DIST= negbin link=log   offset=lrisk ;*TYPE3 WALD;
       %end;
  lsmeans group /  cl;     
 estimate 'test-active' group 1 -1  /exp;      
       run;
 %if &m. eq 1 %then %do;      
 data summary_&seq.;
   set est_group_&m._&seq.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%else  %if &m. ne 1 %then %do;      
 data summary_&seq.;
   set est_group_&m._&seq. summary_&seq.;      
where label eq 'Exp(test-active)';  
upper=LBetaUpperCL;
if upper lt 1 and upper ne . then ind_sup=1;
else if upper ge 1 then ind_sup=0;
marni=&mar_ni.;
if upper < marni and upper ne . then ind_ni=1;
else if upper ge marni then ind_ni=0;
order=1;
run;
%end;
%end;
proc sql noprint;
create table summary1_&seq. as 
  select sum(ind_ni)/sum(order) as pct_ni
	,sum(ind_sup)/sum(order) as pct_sup,label 
	from summary_&seq.
	where ind_ni ne . and ind_sup ne .
	group by label;
	quit;
%mend sim_binom2;


%sim_binom2(N=3000,K=1000, rr_trt=1.025,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff1pois,seq=1);  

%sim_binom2(N=3000,K=1000, rr_trt=1.025,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff2pois,seq=2); 
%sim_binom2(N=3000,K=1000, rr_trt=1.025,lambda_baseline=1.31,op=0.677,mar_ni=1.15,type=rdiff0pois,seq=3); 
                                                                                                